# Subscription & Payment Setup Guide

## Overview

This guide covers the complete setup for Stripe subscription payments in the Mito app.

**Architecture:**
- Free Trial: 3 analyses per patient
- Pro Plan: $29/month, unlimited analyses
- Backend: Express.js with Stripe integration
- Frontend: React with Supabase
- Database: PostgreSQL with RLS

## Setup Steps

### 1. Run Database Migrations

Run these migrations in order:

```bash
# Step 1: Create subscriptions table and functions
npx supabase migration new subscriptions
# Copy contents from supabase/migrations/20250125_subscriptions.sql

# Step 2: Create server-side limit enforcement
npx supabase migration new analyses_limit
# Copy contents from supabase/migrations/20250125_analyses_limit_enforcement.sql

# Apply migrations
npx supabase db push
```

### 2. Backfill Existing Users

Create subscription records for existing users:

```bash
# Dry run first (preview changes)
npm run backfill-subscriptions:dry-run

# Apply the backfill
npm run backfill-subscriptions

# OR: Give existing users Pro for 90 days
npm run backfill-subscriptions:grandfather
```

### 3. Create Stripe Products

```bash
# Create Mito Pro product and price in Stripe
npm run seed-stripe

# This will:
# - Create "Mito Pro" product in Stripe
# - Create $29/month price
# - Store price ID in Supabase config table
```

### 4. Configure Environment Variables

Add these to your Replit Secrets:

```bash
# Required for backend
DATABASE_URL=<your-database-url>
VITE_SUPABASE_URL=<your-supabase-url>
VITE_SUPABASE_ANON_KEY=<your-anon-key>
SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>

# Optional: Backend URL (defaults to localhost:3001 in dev)
VITE_BACKEND_URL=https://your-backend-domain.com
```

### 5. Start the Backend Server

The backend handles Stripe operations:

```bash
# Start backend (port 3001)
npm run dev:backend

# Or run both frontend and backend
npm run dev:all
```

### 6. Configure Webhooks in Stripe Dashboard

1. Go to Stripe Dashboard → Developers → Webhooks
2. Add endpoint: `https://your-backend-domain.com/api/stripe/webhook/{uuid}`
   - The UUID is automatically generated by the backend on startup
   - Check backend logs for the webhook URL
3. Select events to listen for:
   - `checkout.session.completed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`

### 7. Test the Integration

1. **Check subscription status:**
   ```bash
   curl http://localhost:3001/api/subscription \
     -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
   ```

2. **Create checkout session:**
   ```bash
   curl -X POST http://localhost:3001/api/checkout \
     -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
     -H "Content-Type: application/json"
   ```

3. **Test analysis limit:**
   - Upload 3 lab reports for a patient (should work)
   - Try 4th analysis (should trigger paywall)

## Database Schema

### Subscriptions Table

```sql
subscriptions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) UNIQUE,
  stripe_customer_id TEXT UNIQUE,
  stripe_subscription_id TEXT UNIQUE,
  status TEXT NOT NULL DEFAULT 'trialing',
  plan TEXT NOT NULL DEFAULT 'free',
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  cancel_at_period_end BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
)
```

### Key Functions

- `can_analyze_client(p_client_id UUID)` - Check if user can analyze a client
- `get_client_analysis_count(p_client_id UUID)` - Get analysis count for a client
- `get_stripe_price_id(plan_key TEXT)` - Get Stripe price ID from config

## API Endpoints

### Backend API (Port 3001)

- `GET /api/stripe/config` - Get Stripe publishable key
- `GET /api/subscription` - Get user's subscription (requires auth)
- `POST /api/checkout` - Create checkout session (requires auth)
- `POST /api/portal` - Create customer portal session (requires auth)
- `POST /api/can-analyze` - Check if user can analyze client (requires auth)
- `GET /api/products` - Get available products/prices
- `POST /api/stripe/webhook/:uuid` - Stripe webhook handler

## Frontend Integration

### useSubscription Hook

```typescript
import { useSubscription } from '@/hooks/useSubscription';

function MyComponent() {
  const { subscription, loading, isPro, isTrialing } = useSubscription();

  if (loading) return <LoadingSpinner />;

  return (
    <div>
      <p>Plan: {subscription?.plan}</p>
      <p>Status: {subscription?.status}</p>
      {isPro && <ProFeatures />}
    </div>
  );
}
```

### Subscription Service

```typescript
import { canAnalyzeClient, createCheckoutSession } from '@/lib/subscription-service';

// Check if user can analyze
const { allowed, currentCount, limit } = await canAnalyzeClient(clientId);

if (!allowed) {
  // Show upgrade modal
  const checkoutUrl = await createCheckoutSession();
  window.location.href = checkoutUrl;
}
```

### UpgradeModal Component

```typescript
import { UpgradeModal } from '@/components/UpgradeModal';

<UpgradeModal
  open={showUpgradeModal}
  onOpenChange={setShowUpgradeModal}
  currentCount={3}
  patientName="John Doe"
/>
```

## Remaining TODOs

1. **Integrate subscription checks into HomePage analysis flow**
   - Add check before processing files
   - Show UpgradeModal if limit exceeded
   - Only proceed if allowed

2. **Add subscription management UI to Settings page**
   - Display current plan and status
   - Show analysis usage stats
   - Button to upgrade (free users)
   - Button to manage subscription (pro users)

3. **Update workflows**
   - Create workflow to run backend server on port 3001
   - Keep existing frontend workflow on port 5000

4. **Testing**
   - Test free trial limit enforcement
   - Test checkout flow end-to-end
   - Test webhook handling
   - Test customer portal

## Security Notes

- ✅ RLS policies prevent users from modifying plan/status
- ✅ Service role required for webhook updates
- ✅ BEFORE INSERT trigger enforces limits server-side
- ✅ Client-side checks are backed by server-side validation
- ✅ Stripe webhook signature verification enabled
- ✅ User IDs passed via `client_reference_id` (reliable in webhooks)

## Troubleshooting

### "Analysis limit exceeded" error
- Check subscription status: `SELECT * FROM subscriptions WHERE user_id = 'USER_ID';`
- Verify trigger is active: `SELECT * FROM pg_trigger WHERE tgname = 'check_analysis_limit';`

### Webhook not receiving events
- Check webhook URL in backend logs
- Verify endpoint in Stripe Dashboard
- Check webhook signing secret

### Checkout session not creating
- Verify Stripe API keys are correct
- Check backend logs for errors
- Ensure user has valid session

## Support

For issues or questions:
1. Check backend logs: `npm run dev:backend`
2. Check database logs in Supabase Dashboard
3. Check Stripe Dashboard for webhook deliveries
4. Review this guide for setup steps
